name: Build Android Client
permissions:
  contents: read

on:
  push:
    branches: [ master ]
    paths:
      - 'client/**'
      - 'common/**'
      - '.github/workflows/build-android.yml'
  pull_request:
    paths:
      - 'client/**'
      - 'common/**'
      - '.github/workflows/build-android.yml'
  workflow_call:
    inputs:
      build_mode:
        description: 'Build mode (debug or release)'
        required: false
        default: 'debug'
        type: string
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  BUILD_MODE: ${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }}

jobs:
  # Build native libraries for each target in parallel
  build-native:
    name: Build ${{ matrix.target }} native library
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64
            rust_target: aarch64-linux-android
            abi: arm64-v8a
            cc: aarch64-linux-android27-clang
            cxx: aarch64-linux-android27-clang++
            linker: aarch64-linux-android27-clang
            lib_dir: aarch64-linux-android
          - target: armv7
            rust_target: armv7-linux-androideabi
            abi: armeabi-v7a
            cc: armv7a-linux-androideabi27-clang
            cxx: armv7a-linux-androideabi27-clang++
            linker: armv7a-linux-androideabi27-clang
            lib_dir: arm-linux-androideabi

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27c
          add-to-path: false

      - name: Set up Android SDK CMake
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "cmake;3.22.1"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "."
          shared-key: "android-${{ matrix.target }}"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libssl-dev \
            cmake \
            ninja-build \
            build-essential \
            libclang-dev \
            clang \
            llvm-dev
          sudo apt-get clean

      - name: Set up Android environment
        run: |
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV

          CMAKE_VERSION="3.22.1"
          ANDROID_CMAKE_PATH="$ANDROID_HOME/cmake/$CMAKE_VERSION/bin"
          if [ -d "$ANDROID_CMAKE_PATH" ]; then
            echo "ANDROID_CMAKE_PATH=$ANDROID_CMAKE_PATH" >> $GITHUB_ENV
            echo "CMAKE=$ANDROID_CMAKE_PATH/cmake" >> $GITHUB_ENV
            echo "$ANDROID_CMAKE_PATH" >> $GITHUB_PATH
          else
            echo "CMAKE=cmake" >> $GITHUB_ENV
          fi

          echo "CMAKE_GENERATOR=Ninja" >> $GITHUB_ENV

          ANDROID_SYSROOT="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          echo 'BINDGEN_EXTRA_CLANG_ARGS=--sysroot='"$ANDROID_SYSROOT"' --target=${{ matrix.rust_target }}27' >> $GITHUB_ENV

          test -f "$ANDROID_SYSROOT/usr/include/stdlib.h" && echo "Found stdlib.h in sysroot" || (echo "Missing stdlib.h"; exit 1)

          echo "CARGO_NDK_PLATFORM=27" >> $GITHUB_ENV
          echo "ANDROID_PLATFORM=android-27" >> $GITHUB_ENV
          echo "CMAKE_ANDROID_API=27" >> $GITHUB_ENV
          echo "ANDROID_MIN_SDK_VERSION=27" >> $GITHUB_ENV

      - name: Install bindgen
        working-directory: ./client
        run: cargo install --force --locked bindgen-cli

      - name: Setup cargo config for Android
        run: |
          mkdir -p client/src-tauri/.cargo
          cp .github/client/.cargo/config.toml client/src-tauri/.cargo/config.toml

      - name: Build native library for ${{ matrix.target }}
        env:
          LIBCLANG_PATH: /usr/lib/llvm-17/lib/
          LD_LIBRARY_PATH: /usr/lib/llvm-17/lib/:$LD_LIBRARY_PATH
          ANDROID_NDK_HOME: "$ANDROID_NDK_ROOT"
          CMAKE_GENERATOR: "Ninja"
          CMAKE: "cmake"
          AWS_LC_SYS_CMAKE_GENERATOR: "Ninja"
          AWS_LC_SYS_CMAKE_BUILDER: "1"
          AWS_LC_SYS_EXTERNAL_BINDGEN: "1"
          ANDROID_PLATFORM: "android-27"
          CMAKE_ANDROID_API: "27"
        run: |
          export PATH="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

          # Set RUSTFLAGS for this target
          if [ "${{ matrix.target }}" = "aarch64" ]; then
            export CARGO_TARGET_AARCH64_LINUX_ANDROID_RUSTFLAGS="-Clinker=${{ matrix.linker }} --cfg s2n_quic_unstable -C link-arg=-lc++_shared -L $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/${{ matrix.lib_dir }}/27"
          else
            export CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_RUSTFLAGS="-Clinker=${{ matrix.linker }} --cfg s2n_quic_unstable -C link-arg=-lc++_shared -L $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/${{ matrix.lib_dir }}/27"
          fi

          echo "Building ${{ matrix.target }} in ${{ env.BUILD_MODE }} mode using cargo directly"
          if [ "${{ env.BUILD_MODE }}" = "release" ]; then
            cargo build --target ${{ matrix.rust_target }} --release --lib -p bedrock-voice-chat-client
          else
            cargo build --target ${{ matrix.rust_target }} --lib -p bedrock-voice-chat-client
          fi

          echo "=== Built library ==="
          ls -la target/${{ matrix.rust_target }}/${{ env.BUILD_MODE }}/libbvc_client_lib.so

      - name: Upload native library artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-lib-${{ matrix.abi }}-${{ env.BUILD_MODE }}
          path: target/${{ matrix.rust_target }}/${{ env.BUILD_MODE }}/libbvc_client_lib.so
          retention-days: 1

  # Assemble the universal APK from native libraries
  assemble-apk:
    name: Assemble Universal APK (${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }})
    needs: [build-native]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'yarn'
          cache-dependency-path: client/yarn.lock

      - name: Install JavaScript dependencies
        working-directory: ./client
        run: yarn install --frozen-lockfile

      - name: Initialize Tauri Android project
        working-directory: ./client
        run: |
          yarn tauri android init
          # Adjust SDK versions
          sed -i 's/minSdk[[:space:]]*=[[:space:]]*[0-9]\+/minSdk = 35/' src-tauri/gen/android/app/build.gradle.kts || true
          sed -i 's/compileSdk[[:space:]]*=[[:space:]]*[0-9]\+/compileSdk = 36/' src-tauri/gen/android/app/build.gradle.kts || true
          sed -i 's/targetSdk[[:space:]]*=[[:space:]]*[0-9]\+/targetSdk = 36/' src-tauri/gen/android/app/build.gradle.kts || true
          echo "Android project initialized"

      - name: Copy custom Android icons
        working-directory: ./client
        run: |
          SOURCE_ICONS="src-tauri/icons/android"
          TARGET_RES="src-tauri/gen/android/app/src/main/res"

          for MIPMAP_DIR in mipmap-hdpi mipmap-mdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi; do
            SOURCE_PATH="$SOURCE_ICONS/$MIPMAP_DIR"
            TARGET_PATH="$TARGET_RES/$MIPMAP_DIR"
            if [ -d "$SOURCE_PATH" ]; then
              mkdir -p "$TARGET_PATH"
              cp "$SOURCE_PATH/ic_launcher.png" "$TARGET_PATH/ic_launcher.png"
              echo "Copied $MIPMAP_DIR/ic_launcher.png"
            fi
          done

      - name: Download arm64-v8a native library
        uses: actions/download-artifact@v4
        with:
          name: native-lib-arm64-v8a-${{ env.BUILD_MODE }}
          path: native-libs/arm64-v8a

      - name: Download armeabi-v7a native library
        uses: actions/download-artifact@v4
        with:
          name: native-lib-armeabi-v7a-${{ env.BUILD_MODE }}
          path: native-libs/armeabi-v7a

      - name: Place native libraries in jniLibs
        working-directory: ./client
        run: |
          JNILIBS_DIR="src-tauri/gen/android/app/src/main/jniLibs"
          mkdir -p "$JNILIBS_DIR/arm64-v8a"
          mkdir -p "$JNILIBS_DIR/armeabi-v7a"

          cp ../native-libs/arm64-v8a/libbvc_client_lib.so "$JNILIBS_DIR/arm64-v8a/"
          cp ../native-libs/armeabi-v7a/libbvc_client_lib.so "$JNILIBS_DIR/armeabi-v7a/"

          echo "=== jniLibs structure ==="
          find "$JNILIBS_DIR" -type f -exec ls -la {} \;

      - name: Assemble Universal APK
        working-directory: ./client/src-tauri/gen/android
        run: |
          if [ "${{ env.BUILD_MODE }}" = "release" ]; then
            ./gradlew assembleUniversalRelease --no-daemon
          else
            ./gradlew assembleUniversalDebug --no-daemon
          fi

      - name: Prepare Android artifacts
        working-directory: ./client
        run: |
          APK_PATH="src-tauri/gen/android/app/build/outputs/apk/universal/${{ env.BUILD_MODE }}/app-universal-${{ env.BUILD_MODE }}.apk"

          if [ -f "$APK_PATH" ]; then
            echo "Found APK at: $APK_PATH"
            cp "$APK_PATH" "bvc-android-${{ env.BUILD_MODE }}.apk"
            echo "=== Final APK ==="
            ls -la "bvc-android-${{ env.BUILD_MODE }}.apk"
          else
            echo "ERROR: APK not found at expected path: $APK_PATH"
            find src-tauri/gen/android/app/build/outputs/apk -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
            exit 1
          fi

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        id: upload-android
        with:
          name: bvc-android-${{ env.BUILD_MODE }}.apk
          path: client/bvc-android-${{ env.BUILD_MODE }}.apk
          retention-days: 30

      - name: Output artifact information
        run: |
          echo "Android Build Complete!"
          echo "Build Mode: ${{ env.BUILD_MODE }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "Artifact URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
