name: Build Android Client
permissions:
  contents: read

on:
  workflow_call:
    inputs:
      build_mode:
        description: 'Build mode (debug or release)'
        required: false
        default: 'debug'
        type: string
      ref:
        description: 'Git ref to checkout (tag, branch, or SHA)'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build-android:
    name: Build Android Client (${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }})
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'yarn'
          cache-dependency-path: client/yarn.lock

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27c
          add-to-path: false

      - name: Set up Android SDK and build tools
        run: |
          # Install Android SDK components via sdkmanager
          echo "Installing Android SDK build tools and CMake..."

          # Accept licenses
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

          # Install required SDK components
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "build-tools;34.0.0" \
            "cmake;3.22.1" \
            "platform-tools" \
            "platforms;android-34"

          echo "Android SDK components installed"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: |
            aarch64-linux-android
            armv7-linux-androideabi

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "."

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libssl-dev \
            libsqlite3-dev \
            cmake \
            ninja-build \
            build-essential \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libclang-dev \
            clang \
            llvm-dev
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android/sdk/system-images
          sudo apt-get clean
          df -h

      - name: Configure git to use HTTPS instead of SSH
        run: |
          git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://github.com/".insteadOf "git+ssh://git@github.com/"

      - name: Install JavaScript dependencies
        working-directory: ./client
        run: yarn install --frozen-lockfile

      - name: Download and setup ASIO SDK
        working-directory: ./client/src-tauri
        run: |
          echo "Downloading ASIO SDK..."
          curl -L -o asiosdk.zip "https://download.steinberg.net/sdk_downloads/asiosdk_2.3.3_2019-06-14.zip"
          unzip -q asiosdk.zip
          ls -la
          echo "ASIO SDK downloaded and extracted"

      - name: Set up Android environment and fix LIBCLANG_PATH
        run: |
          # The setup-ndk action sets ANDROID_NDK_ROOT, but we need to ensure all common NDK env vars are set
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV

          # Set up Android SDK CMake
          CMAKE_VERSION="3.22.1"
          ANDROID_CMAKE_PATH="$ANDROID_HOME/cmake/$CMAKE_VERSION/bin"
          if [ -d "$ANDROID_CMAKE_PATH" ]; then
            echo "ANDROID_CMAKE_PATH=$ANDROID_CMAKE_PATH" >> $GITHUB_ENV
            echo "CMAKE=$ANDROID_CMAKE_PATH/cmake" >> $GITHUB_ENV
            echo "Adding Android CMake to PATH: $ANDROID_CMAKE_PATH"
            echo "$ANDROID_CMAKE_PATH" >> $GITHUB_PATH
          else
            echo "Android CMake not found at $ANDROID_CMAKE_PATH, using system CMake"
            echo "CMAKE=cmake" >> $GITHUB_ENV
          fi

          # Set up Ninja (prefer system ninja)
          echo "CMAKE_GENERATOR=Ninja" >> $GITHUB_ENV

          # Debug: Show what NDK variables are available
          echo "Available NDK environment variables:"
          echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
          echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
          echo "NDK_HOME: $NDK_HOME"

          # Generic flags bindgen & cc should use for Android cross builds
          ANDROID_SYSROOT="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          # Bindgen gets sysroot and a target triple; no __ANDROID_API__ define
          echo 'BINDGEN_EXTRA_CLANG_ARGS=--sysroot='"$ANDROID_SYSROOT"' --target=aarch64-linux-android27' >> $GITHUB_ENV

          # Sanity check: stdlib.h should exist here
          test -f "$ANDROID_SYSROOT/usr/include/stdlib.h" && echo "Found stdlib.h in sysroot" || (echo "Missing stdlib.h"; exit 1)

          echo "CARGO_NDK_PLATFORM=27" >> $GITHUB_ENV
          echo "ANDROID_PLATFORM=android-27" >> $GITHUB_ENV
          echo "CMAKE_ANDROID_API=27" >> $GITHUB_ENV
          echo "ANDROID_MIN_SDK_VERSION=27" >> $GITHUB_ENV

          # Debug: Show build tools
          echo "Build tools verification:"
          cmake --version || echo "CMake not found"
          ninja --version || echo "Ninja not found"

      - name: Install bindgen
        working-directory: ./client
        run: cargo install --force --locked bindgen-cli

      - name: Initialize Tauri Android project
        working-directory: ./client
        run: |
          echo "Setting up .cargo/config.toml for Android build..."
          cp ../.github/client/.cargo/config.toml ./src-tauri/.cargo/config.toml
          cat ./src-tauri/.cargo/config.toml
          echo "Initializing Tauri Android project..."
          yarn tauri android init
          # Groovy
          sed -i 's/minSdkVersion[[:space:]]\+[0-9]\+/minSdkVersion 35/' src-tauri/gen/android/app/build.gradle || true
          # Kotlin DSL
          sed -i 's/minSdk[[:space:]]*=[[:space:]]*[0-9]\+/minSdk = 35/' src-tauri/gen/android/app/build.gradle.kts || true

          # Optional: also raise compileSdk/targetSdk if present
          sed -i 's/compileSdk[[:space:]]*=[[:space:]]*[0-9]\+/compileSdk = 36/' src-tauri/gen/android/app/build.gradle.kts || true
          sed -i 's/targetSdk[[:space:]]*=[[:space:]]*[0-9]\+/targetSdk = 36/' src-tauri/gen/android/app/build.gradle.kts || true

          grep -Rn "minSdk" src-tauri/gen/android || true

          echo "Android project initialized successfully"

      - name: Build Icons
        working-directory: ./client
        run: |
          echo "Copying custom Android icons..."

          SOURCE_ICONS="src-tauri/icons/android"
          TARGET_RES="src-tauri/gen/android/app/src/main/res"

          if [ ! -d "$SOURCE_ICONS" ]; then
            echo "Warning: Source icons path not found: $SOURCE_ICONS"
            exit 1
          fi

          if [ ! -d "$TARGET_RES" ]; then
            echo "Warning: Target Android resources path not found: $TARGET_RES"
            exit 1
          fi

          # Copy each mipmap directory (excluding mipmap-anydpi-v26 to use regular PNG icons instead of adaptive)
          for MIPMAP_DIR in mipmap-hdpi mipmap-mdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi; do
            SOURCE_PATH="$SOURCE_ICONS/$MIPMAP_DIR"
            TARGET_PATH="$TARGET_RES/$MIPMAP_DIR"

            if [ -d "$SOURCE_PATH" ]; then
              mkdir -p "$TARGET_PATH"

              # Copy PNG icon files
              for ICON_FILE in ic_launcher.png ic_launcher_round.png ic_launcher_foreground.png; do
                SOURCE_ICON="$SOURCE_PATH/$ICON_FILE"
                TARGET_ICON="$TARGET_PATH/$ICON_FILE"

                if [ -f "$SOURCE_ICON" ]; then
                  cp "$SOURCE_ICON" "$TARGET_ICON"
                  echo "Copied $MIPMAP_DIR/$ICON_FILE"
                fi
              done
            else
              echo "Missing source directory: $SOURCE_PATH"
              exit 1
            fi
          done

          # Remove mipmap-anydpi-v26 to disable adaptive icons (use regular PNGs instead)
          ANYDPI_PATH="$TARGET_RES/mipmap-anydpi-v26"
          if [ -d "$ANYDPI_PATH" ]; then
            rm -rf "$ANYDPI_PATH"
            echo "Removed mipmap-anydpi-v26 (using regular PNG icons)"
          fi

          echo "Android icon copying completed."

          # Verify icons were copied
          echo "Verifying copied icons:"
          find "$TARGET_RES" -name "ic_launcher*" -exec ls -la {} \;

      - name: Build Android
        working-directory: ./client
        env:
          # libclang - keep using the system libclang 17
          LIBCLANG_PATH: /usr/lib/llvm-17/lib/
          LD_LIBRARY_PATH: /usr/lib/llvm-17/lib/:$LD_LIBRARY_PATH

          # NDK env
          ANDROID_NDK_HOME: "$ANDROID_NDK_ROOT"

          # Toolchain
          CMAKE_GENERATOR: "Ninja"
          CMAKE: "cmake"
          AWS_LC_SYS_CMAKE_GENERATOR: "Ninja"
          AWS_LC_SYS_CMAKE_BUILDER: "1"
          AWS_LC_SYS_EXTERNAL_BINDGEN: "1"

          # Android NDK toolchain setup (API 27)
          CC_aarch64_linux_android: "aarch64-linux-android27-clang"
          CXX_aarch64_linux_android: "aarch64-linux-android27-clang++"
          AR_aarch64_linux_android: "llvm-ar"
          CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: "aarch64-linux-android27-clang"

          CC_armv7_linux_androideabi: "armv7a-linux-androideabi27-clang"
          CXX_armv7_linux_androideabi: "armv7a-linux-androideabi27-clang++"
          AR_armv7_linux_androideabi: "llvm-ar"
          CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER: "armv7a-linux-androideabi27-clang"

          # RUSTFLAGS (unchanged)
          CARGO_TARGET_AARCH64_LINUX_ANDROID_RUSTFLAGS: >-
            -Clinker=aarch64-linux-android27-clang
            --cfg s2n_quic_unstable
            -C link-arg=-lc++_shared
            -L $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/27

          # ARMv7
          CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_RUSTFLAGS: >-
            -Clinker=armv7a-linux-androideabi27-clang
            --cfg s2n_quic_unstable
            -C link-arg=-lc++_shared
            -L $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/arm-linux-androideabi/27

          ANDROID_PLATFORM: "android-27"
          CMAKE_ANDROID_API: "27"
        run: |
          export PATH="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          yarn tauri info
          # Force debug mode for PR builds, otherwise use input parameter
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR detected - building in debug mode"
            yarn tauri android build --debug --target aarch64 armv7
          elif [ "${{ inputs.build_mode || 'debug' }}" = "release" ]; then
            echo "Building in release mode"
            yarn tauri android build --target aarch64 armv7
          else
            echo "Building in debug mode"
            yarn tauri android build --debug --target aarch64 armv7
          fi

      - name: Prepare Android artifacts
        working-directory: ./client
        run: |
          # Determine actual build mode used
          BUILD_MODE="${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }}"
          echo "Effective build mode: $BUILD_MODE"

          # Use the correct path structure for APK
          # Debug builds produce: app-universal-debug.apk
          # Release builds produce: app-universal-release-unsigned.apk
          if [ "$BUILD_MODE" = "release" ]; then
            APK_PATH="src-tauri/gen/android/app/build/outputs/apk/universal/$BUILD_MODE/app-universal-$BUILD_MODE-unsigned.apk"
          else
            APK_PATH="src-tauri/gen/android/app/build/outputs/apk/universal/$BUILD_MODE/app-universal-$BUILD_MODE.apk"
          fi

          if [ -f "$APK_PATH" ]; then
            echo "Found APK at: $APK_PATH"
            cp "$APK_PATH" "bvc-android-$BUILD_MODE.apk"
            echo "=== Final APK ==="
            ls -la "bvc-android-$BUILD_MODE.apk"
          else
            echo "ERROR: APK not found at expected path: $APK_PATH"
            echo "=== Searching for any APK files ==="
            find src-tauri/gen/android/app/build/outputs/apk -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
            exit 1
          fi

          # For release builds, also copy the AAB (Android App Bundle)
          if [ "$BUILD_MODE" = "release" ]; then
            AAB_PATH="src-tauri/gen/android/app/build/outputs/bundle/universalRelease/app-universal-release.aab"
            if [ -f "$AAB_PATH" ]; then
              echo "Found AAB at: $AAB_PATH"
              cp "$AAB_PATH" "bvc-android-$BUILD_MODE.aab"
              echo "=== Final AAB ==="
              ls -la "bvc-android-$BUILD_MODE.aab"
            else
              echo "WARNING: AAB not found at expected path: $AAB_PATH"
              echo "=== Searching for any AAB files ==="
              find src-tauri/gen/android/app/build/outputs/bundle -name "*.aab" -type f 2>/dev/null || echo "No AAB files found"
            fi
          fi

      - name: Upload Android APK artifact
        uses: actions/upload-artifact@v4
        id: upload-android
        with:
          name: bvc-android-${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }}.apk
          path: client/bvc-android-${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }}.apk
          retention-days: 30

      - name: Upload Android AAB artifact (unsigned)
        if: github.event_name != 'pull_request' && inputs.build_mode == 'release'
        uses: actions/upload-artifact@v4
        id: upload-android-aab
        with:
          name: bvc-android-release.aab
          path: client/bvc-android-release.aab
          retention-days: 30

      - name: Sign Android APK
        if: github.event_name != 'pull_request' && inputs.build_mode == 'release'
        working-directory: ./client
        run: |
          echo "Decoding keystore..."
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > upload-keystore.jks

          echo "Signing APK..."
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --ks upload-keystore.jks \
            --ks-pass pass:${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }} \
            --ks-key-alias ${{ secrets.ANDROID_KEY_ALIAS }} \
            --key-pass pass:${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }} \
            --out bvc-android-release-signed.apk \
            bvc-android-release.apk

          echo "Verifying APK signature..."
          $ANDROID_HOME/build-tools/34.0.0/apksigner verify --verbose bvc-android-release-signed.apk

          echo "=== Signed APK ==="
          ls -la bvc-android-release-signed.apk

      - name: Sign Android AAB
        if: github.event_name != 'pull_request' && inputs.build_mode == 'release'
        working-directory: ./client
        run: |
          echo "Decoding keystore..."
          if [ ! -f upload-keystore.jks ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > upload-keystore.jks
          fi

          echo "Signing AAB..."
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore upload-keystore.jks \
            -storepass ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }} \
            -keypass ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }} \
            bvc-android-release.aab \
            ${{ secrets.ANDROID_KEY_ALIAS }}

          mv bvc-android-release.aab bvc-android-release-signed.aab

          echo "Verifying AAB signature..."
          jarsigner -verify -verbose bvc-android-release-signed.aab

          echo "=== Signed AAB ==="
          ls -la bvc-android-release-signed.aab

      - name: Upload signed APK artifact
        if: github.event_name != 'pull_request' && inputs.build_mode == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: bvc-android-release-signed.apk
          path: client/bvc-android-release-signed.apk
          retention-days: 90

      - name: Upload signed AAB artifact
        if: github.event_name != 'pull_request' && inputs.build_mode == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: bvc-android-release-signed.aab
          path: client/bvc-android-release-signed.aab
          retention-days: 90

      - name: Output artifact information
        run: |
          BUILD_MODE="${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }}"
          {
            echo "## Android Build Complete"
            echo ""
            echo "| Name | Value |"
            echo "| ---- | ----- |"
            echo "| Build Mode | $BUILD_MODE |"
            echo "| Trigger | ${{ github.event_name }} |"
            echo "| Artifact | bvc-android-$BUILD_MODE.apk |"
            echo "| Artifact URL | [View Run](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}) |"
            echo "| Retention | 30 days |"
          } >> $GITHUB_STEP_SUMMARY