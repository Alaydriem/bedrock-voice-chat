name: Mods Release

on:
  workflow_call:
    inputs:
      skip_server_build:
        description: 'Skip server build (reuse artifacts from caller)'
        required: false
        default: false
        type: boolean
      version:
        description: 'Version (passed from release.yml)'
        required: false
        type: string
      dry-run:
        description: 'Dry run mode'
        required: false
        default: false
        type: boolean
      parent_run_id:
        description: 'Parent workflow run ID for artifact download'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      dry-run:
        description: >
          Dry run the release creation (simulate)
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  actions: read

defaults:
  run:
    shell: bash

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    outputs:
      new_release_published: ${{ inputs.version != '' && 'true' || steps.semantic-release.outputs.new_release_published }}
      new_release_version: ${{ inputs.version || steps.semantic-release.outputs.new_release_version }}
      new_release_git_tag: ${{ inputs.version != '' && format('mods-v{0}', inputs.version) || steps.semantic-release.outputs.new_release_git_tag }}
      new_release_notes: ${{ steps.semantic-release.outputs.new_release_notes }}
    steps:
      - name: Checkout Code
        if: ${{ inputs.version == '' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          show-progress: false
          ref: ${{ github.ref }}

      - name: Fetch all tags
        if: ${{ inputs.version == '' }}
        run: git fetch --tags --force

      - name: Semantic Release
        if: ${{ inputs.version == '' }}
        id: semantic-release
        uses: cycjimmy/semantic-release-action@v4
        with:
          working_directory: ./mods/java
          dry_run: ${{ inputs.dry-run }}
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/exec
            @semantic-release/git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary (standalone)
        if: ${{ inputs.version == '' && steps.semantic-release.outputs.new_release_published }}
        run: |
          # Generate a GitHub summary
          {
              echo "## Mods Release ${{ steps.semantic-release.outputs.new_release_version }}"
              echo ""
              echo "| Name | Value |"
              echo "| ---- | ----- |"
              echo "| Release | [${{ steps.semantic-release.outputs.new_release_version }}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/releases/tag/${{ steps.semantic-release.outputs.new_release_git_tag }}) |"
              echo "| Release Type | ${{ github.ref_name == 'beta' && 'beta' || 'release' }} |"
              echo "| Old Version | [${{ steps.semantic-release.outputs.last_release_git_tag }}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/releases/tag/${{ steps.semantic-release.outputs.last_release_git_tag }}) |"
              echo "| Diff | [${{ steps.semantic-release.outputs.last_release_git_tag }}...${{ steps.semantic-release.outputs.new_release_git_tag }}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/compare/${{ steps.semantic-release.outputs.last_release_git_tag }}...${{ steps.semantic-release.outputs.new_release_git_tag }}) |"
              echo "| Browse files | [${{ steps.semantic-release.outputs.new_release_git_tag }}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/tree/${{ steps.semantic-release.outputs.new_release_git_tag }}) |"
              echo "| Commit | [${{ steps.semantic-release.outputs.new_release_git_head }}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${{ steps.semantic-release.outputs.new_release_git_head }}) |"
              echo "| Dry Run | ${{ inputs.dry-run && 'Yes' || 'No' }} |"
              echo ""
              echo "> **Note:** Links to the new version will only work after the release is created"
          } >> $GITHUB_STEP_SUMMARY

      - name: Summary (called from release.yml)
        if: ${{ inputs.version != '' }}
        run: |
          {
              echo "## Mods Release (from main release)"
              echo ""
              echo "| Name | Value |"
              echo "| ---- | ----- |"
              echo "| Version | ${{ inputs.version }} |"
              echo "| Server Build | Skipped (reusing artifacts) |"
          } >> $GITHUB_STEP_SUMMARY

  # Build server first to produce native libraries for mods
  # Skip if called from release.yml (artifacts already built)
  build-server:
    name: Build Server (for native libraries)
    needs: prepare-release
    if: ${{ !inputs.skip_server_build && needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run }}
    uses: ./.github/workflows/build-server.yml
    with:
      build_mode: release
      skip_docker: true
    secrets: inherit

  build-mod-fabric:
    name: Build Fabric Mod
    needs: [prepare-release, build-server]
    # Run if: release is published, not dry-run, and (server build succeeded OR was skipped)
    if: always() && needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run && (needs.build-server.result == 'success' || needs.build-server.result == 'skipped')
    uses: ./.github/workflows/build-mod-fabric.yml
    with:
      version: ${{ needs.prepare-release.outputs.new_release_version }}
      artifact_run_id: ${{ inputs.parent_run_id }}
    secrets: inherit

  build-mod-paper:
    name: Build Paper Plugin
    needs: [prepare-release, build-server]
    # Run if: release is published, not dry-run, and (server build succeeded OR was skipped)
    if: always() && needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run && (needs.build-server.result == 'success' || needs.build-server.result == 'skipped')
    uses: ./.github/workflows/build-mod-paper.yml
    with:
      version: ${{ needs.prepare-release.outputs.new_release_version }}
      artifact_run_id: ${{ inputs.parent_run_id }}
    secrets: inherit

  build-mod-hytale:
    name: Build Hytale Plugin
    needs: [prepare-release, build-server]
    # Run if: release is published, not dry-run, and (server build succeeded OR was skipped)
    if: always() && needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run && (needs.build-server.result == 'success' || needs.build-server.result == 'skipped')
    uses: ./.github/workflows/build-mod-hytale.yml
    with:
      version: ${{ needs.prepare-release.outputs.new_release_version }}
      artifact_run_id: ${{ inputs.parent_run_id }}
    secrets: inherit

  build-mod-bds:
    name: Build BDS Pack
    needs: prepare-release
    if: ${{ needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run }}
    uses: ./.github/workflows/build-mod-bds.yml
    with:
      version: ${{ needs.prepare-release.outputs.new_release_version }}
    secrets: inherit

  publish-modrinth-fabric:
    name: Publish Fabric to Modrinth
    needs: [prepare-release, build-mod-fabric]
    if: ${{ needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-fabric-${{ needs.prepare-release.outputs.new_release_version }}.jar
          path: ./artifacts

      - name: List artifacts
        run: ls -la ./artifacts

      - name: Publish to Modrinth
        uses: cloudnode-pro/modrinth-publish@v2
        with:
          token: ${{ secrets.MODRITH_PAT }}
          project: ${{ secrets.MODRITH_ID }}
          files: ./artifacts/bedrock-voice-chat-${{ needs.prepare-release.outputs.new_release_version }}.jar
          primary-file: bedrock-voice-chat-${{ needs.prepare-release.outputs.new_release_version }}.jar
          version: ${{ needs.prepare-release.outputs.new_release_version }}
          name: Bedrock Voice Chat ${{ needs.prepare-release.outputs.new_release_version }} (Fabric)
          changelog: ${{ needs.prepare-release.outputs.new_release_notes }}
          dependencies: |-
            [{
              "project_id": "P7dR8mSH",
              "dependency_type": "required"
            }]
          loaders: |-
            fabric
          game-versions: |-
            1.21.11
          channel: ${{ github.ref_name == 'beta' && 'beta' || 'release' }}

  publish-modrinth-paper:
    name: Publish Paper to Modrinth
    needs: [prepare-release, build-mod-paper]
    if: ${{ needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-paper-${{ needs.prepare-release.outputs.new_release_version }}.jar
          path: ./artifacts

      - name: List artifacts
        run: ls -la ./artifacts

      - name: Publish to Modrinth
        uses: cloudnode-pro/modrinth-publish@v2
        with:
          token: ${{ secrets.MODRITH_PAT }}
          project: ${{ secrets.MODRITH_ID }}
          files: ./artifacts/bedrock-voice-chat-paper-${{ needs.prepare-release.outputs.new_release_version }}.jar
          primary-file: bedrock-voice-chat-paper-${{ needs.prepare-release.outputs.new_release_version }}.jar
          version: ${{ needs.prepare-release.outputs.new_release_version }}-paper
          name: Bedrock Voice Chat ${{ needs.prepare-release.outputs.new_release_version }} (Paper)
          changelog: ${{ needs.prepare-release.outputs.new_release_notes }}
          loaders: |-
            paper
            spigot
            bukkit
          game-versions: |-
            1.21.11
          channel: ${{ github.ref_name == 'beta' && 'beta' || 'release' }}

  publish-curseforge-hytale:
    name: Publish Hytale to CurseForge
    needs: [prepare-release, build-mod-hytale]
    if: always() && needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run && needs.build-mod-hytale.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-hytale-${{ needs.prepare-release.outputs.new_release_version }}.jar
          path: ./artifacts

      - name: List artifacts
        run: ls -la ./artifacts

      - name: Publish to CurseForge
        uses: itsmeow/curseforge-upload@v3
        with:
          token: ${{ secrets.CURSEFORGE_API_TOKEN }}
          project_id: 1445994
          game_endpoint: hytale
          file_path: ./artifacts/bedrock-voice-chat-hytale-${{ needs.prepare-release.outputs.new_release_version }}.jar
          changelog: ${{ needs.prepare-release.outputs.new_release_notes }}
          changelog_type: markdown
          display_name: Bedrock Voice Chat ${{ needs.prepare-release.outputs.new_release_version }}
          release_type: ${{ github.ref_name == 'beta' && 'beta' || 'release' }}

  publish-curseforge-bds:
    name: Publish BDS to CurseForge
    needs: [prepare-release, build-mod-bds]
    if: always() && needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run && needs.build-mod-bds.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-bds-${{ needs.prepare-release.outputs.new_release_version }}.zip
          path: ./artifacts

      - name: List artifacts
        run: ls -la ./artifacts

      - name: Rename to mcpack for CurseForge
        run: |
          mv ./artifacts/bedrock-voice-chat-${{ needs.prepare-release.outputs.new_release_version }}.zip \
             ./artifacts/bedrock-voice-chat-${{ needs.prepare-release.outputs.new_release_version }}.mcpack

      - name: Publish to CurseForge
        uses: itsmeow/curseforge-upload@v3
        with:
          token: ${{ secrets.CURSEFORGE_API_TOKEN }}
          project_id: 1445992
          game_endpoint: minecraft
          file_path: ./artifacts/bedrock-voice-chat-${{ needs.prepare-release.outputs.new_release_version }}.mcpack
          changelog: ${{ needs.prepare-release.outputs.new_release_notes }}
          changelog_type: markdown
          display_name: Bedrock Voice Chat ${{ needs.prepare-release.outputs.new_release_version }}
          game_versions: Bedrock
          release_type: ${{ github.ref_name == 'beta' && 'beta' || 'release' }}

  # Upload all mod artifacts to GitHub Release
  upload-release-assets:
    name: Upload Release Assets
    needs: [prepare-release, build-mod-fabric, build-mod-paper, build-mod-hytale, build-mod-bds]
    if: always() && needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run && (needs.build-mod-fabric.result == 'success' || needs.build-mod-paper.result == 'success' || needs.build-mod-hytale.result == 'success' || needs.build-mod-bds.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Fabric artifact
        if: needs.build-mod-fabric.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-fabric-${{ needs.prepare-release.outputs.new_release_version }}.jar
          path: ./release-files

      - name: Download Paper artifact
        if: needs.build-mod-paper.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-paper-${{ needs.prepare-release.outputs.new_release_version }}.jar
          path: ./release-files

      - name: Download Hytale artifact
        if: needs.build-mod-hytale.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-hytale-${{ needs.prepare-release.outputs.new_release_version }}.jar
          path: ./release-files

      - name: Download BDS artifact
        if: needs.build-mod-bds.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-bds-${{ needs.prepare-release.outputs.new_release_version }}.zip
          path: ./release-files

      - name: Rename artifacts
        run: |
          VERSION="${{ needs.prepare-release.outputs.new_release_version }}"
          cd ./release-files

          # Rename to consistent naming
          if [ -f "bedrock-voice-chat-${VERSION}.jar" ]; then
            mv "bedrock-voice-chat-${VERSION}.jar" "bvc-fabric-mod-${VERSION}.jar"
          fi

          if [ -f "bedrock-voice-chat-paper-${VERSION}.jar" ]; then
            mv "bedrock-voice-chat-paper-${VERSION}.jar" "bvc-paper-plugin-${VERSION}.jar"
          fi

          if [ -f "bedrock-voice-chat-hytale-${VERSION}.jar" ]; then
            mv "bedrock-voice-chat-hytale-${VERSION}.jar" "bvc-hytale-plugin-${VERSION}.jar"
          fi

          if [ -f "bedrock-voice-chat-${VERSION}.zip" ]; then
            mv "bedrock-voice-chat-${VERSION}.zip" "bvc-bds-pack-${VERSION}.zip"
          fi

          echo "=== Release files ==="
          ls -la

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: mods-v${{ needs.prepare-release.outputs.new_release_version }}
          files: |
            ./release-files/*.jar
            ./release-files/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          VERSION="${{ needs.prepare-release.outputs.new_release_version }}"
          {
            echo "## Mods Release Assets Uploaded"
            echo ""
            echo "Version: **mods-v${VERSION}**"
            echo ""
            echo "### Uploaded Files"
            echo ""
            for file in ./release-files/*; do
              if [ -f "$file" ]; then
                echo "- \`$(basename $file)\`"
              fi
            done
          } >> $GITHUB_STEP_SUMMARY
