name: Build Hytale Plugin

on:
  push:
    branches: [ master ]
    paths:
      - 'mods/java/**'
      - '.github/workflows/build-mod-hytale.yml'
  pull_request:
  workflow_call:
    inputs:
      version:
        description: 'Version to build (overrides gradle.properties)'
        required: false
        type: string
    secrets:
      HYTALE_DOWNLOADER_CREDENTIALS:
        description: 'Hytale downloader credentials JSON'
        required: false
    outputs:
      version:
        description: 'The version that was built'
        value: ${{ jobs.build.outputs.version }}
      artifact-name:
        description: 'Name of the uploaded artifact'
        value: ${{ jobs.build.outputs.artifact-name }}
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (leave empty to use gradle.properties)'
        required: false
        type: string

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build Hytale Plugin
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.mod-version.outputs.version }}
      artifact-name: ${{ steps.mod-version.outputs.artifact-name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Get mod version
        id: mod-version
        working-directory: ./mods/java
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "Using provided version: $VERSION"
          else
            VERSION=$(grep "modVersion" gradle.properties | cut -d'=' -f2)
            echo "Using gradle.properties version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "artifact-name=bedrock-voice-chat-hytale-$VERSION" >> $GITHUB_OUTPUT

      - name: Refresh and setup Hytale credentials
        if: ${{ secrets.HYTALE_DOWNLOADER_CREDENTIALS != '' }}
        env:
          CREDENTIALS_JSON: ${{ secrets.HYTALE_DOWNLOADER_CREDENTIALS }}
        run: |
          # Extract refresh token from existing credentials
          REFRESH_TOKEN=$(echo "$CREDENTIALS_JSON" | jq -r '.refresh_token')
          if [ -z "$REFRESH_TOKEN" ] || [ "$REFRESH_TOKEN" = "null" ]; then
            echo "::warning::No refresh_token found, using existing credentials"
            echo "$CREDENTIALS_JSON" > mods/java/.hytale-downloader-credentials.json
            exit 0
          fi

          # Call the Ory OAuth2 token endpoint
          RESPONSE=$(curl -s -X POST "https://oauth.accounts.hytale.com/oauth2/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token" \
            -d "refresh_token=${REFRESH_TOKEN}" \
            -d "client_id=hytale-server")

          # Check for errors
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR=$(echo "$RESPONSE" | jq -r '.error_description // .error')
            echo "::warning::Token refresh failed: $ERROR - using existing credentials"
            echo "$CREDENTIALS_JSON" > mods/java/.hytale-downloader-credentials.json
            exit 0
          fi

          # Extract tokens
          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')
          NEW_REFRESH_TOKEN=$(echo "$RESPONSE" | jq -r '.refresh_token // empty')

          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "::warning::No access token in response, using existing credentials"
            echo "$CREDENTIALS_JSON" > mods/java/.hytale-downloader-credentials.json
            exit 0
          fi

          # Build and write credentials JSON
          jq -n \
            --arg at "$ACCESS_TOKEN" \
            --arg rt "${NEW_REFRESH_TOKEN:-$REFRESH_TOKEN}" \
            '{access_token: $at, refresh_token: $rt}' > mods/java/.hytale-downloader-credentials.json

          echo "::notice::Token refreshed successfully"

      - name: Build Hytale module
        working-directory: ./mods/java
        run: |
          chmod +x gradlew
          ./gradlew :hytale:shadowJar --no-daemon -PmodVersion=${{ steps.mod-version.outputs.version }}

      - name: Prepare artifact
        shell: bash
        run: |
          cd mods/java/hytale/build/libs
          JAR_FILE=$(find . -name "*.jar" ! -name "*-sources.jar" -type f | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "No JAR file found!"
            exit 1
          fi

          echo "Found JAR: $JAR_FILE"
          ls -lh "$JAR_FILE"

          # Copy to a consistent name for artifact upload
          cp "$JAR_FILE" ../../../../../bedrock-voice-chat-hytale-${{ steps.mod-version.outputs.version }}.jar

          echo "Prepared artifact: bedrock-voice-chat-hytale-${{ steps.mod-version.outputs.version }}.jar"

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: bedrock-voice-chat-hytale-${{ steps.mod-version.outputs.version }}
          path: bedrock-voice-chat-hytale-${{ steps.mod-version.outputs.version }}.jar
          retention-days: 30

      - name: Output artifact information
        shell: bash
        run: |
          {
            echo "## Hytale Plugin Build Complete"
            echo ""
            echo "| Name | Value |"
            echo "| ---- | ----- |"
            echo "| Version | ${{ steps.mod-version.outputs.version }} |"
            echo "| Trigger | ${{ github.event_name }} |"
            echo "| Artifact | bedrock-voice-chat-hytale-${{ steps.mod-version.outputs.version }} |"
            echo "| Artifact URL | [View Run](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}) |"
            echo "| Retention | 30 days |"
          } >> $GITHUB_STEP_SUMMARY
