name: Modrinth Release

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: >
          Dry run the release creation (simulate)
        type: boolean
        default: false

defaults:
  run:
    shell: bash

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions: write-all
    outputs:
      new_release_published: ${{ steps.semantic-release.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic-release.outputs.new_release_version }}
      new_release_git_tag: ${{ steps.semantic-release.outputs.new_release_git_tag }}
      new_release_notes: ${{ steps.semantic-release.outputs.new_release_notes }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          show-progress: false
          ref: ${{ github.ref }}

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Semantic Release
        id: semantic-release
        uses: cycjimmy/semantic-release-action@v4
        with:
          working_directory: ./mods/java
          dry_run: ${{ inputs.dry-run }}
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: ${{ steps.semantic-release.outputs.new_release_published }}
        run: |
          # Generate a GitHub summary
          {
              echo "## Modrinth Release ${{ steps.semantic-release.outputs.new_release_version }}"
              echo ""
              echo "| Name | Value |"
              echo "| ---- | ----- |"
              echo "| Release | [${{ steps.semantic-release.outputs.new_release_version }}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/releases/tag/${{ steps.semantic-release.outputs.new_release_git_tag }}) |"
              echo "| Release Type | ${{ github.ref_name == 'beta' && 'beta' || 'release' }} |"
              echo "| Old Version | [${{ steps.semantic-release.outputs.last_release_git_tag }}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/releases/tag/${{ steps.semantic-release.outputs.last_release_git_tag }}) |"
              echo "| Diff | [${{ steps.semantic-release.outputs.last_release_git_tag }}...${{ steps.semantic-release.outputs.new_release_git_tag }}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/compare/${{ steps.semantic-release.outputs.last_release_git_tag }}...${{ steps.semantic-release.outputs.new_release_git_tag }}) |"
              echo "| Browse files | [${{ steps.semantic-release.outputs.new_release_git_tag }}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/tree/${{ steps.semantic-release.outputs.new_release_git_tag }}) |"
              echo "| Commit | [${{ steps.semantic-release.outputs.new_release_git_head }}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${{ steps.semantic-release.outputs.new_release_git_head }}) |"
              echo "| Dry Run | ${{ inputs.dry-run && 'Yes' || 'No' }} |"
              echo ""
              echo "> **Note:** Links to the new version will only work after the release is created"
          } >> $GITHUB_STEP_SUMMARY

  # Build server first to produce native libraries for mods
  build-server:
    name: Build Server (for native libraries)
    needs: prepare-release
    if: ${{ needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run }}
    uses: ./.github/workflows/build-server.yml
    with:
      build_mode: release
    secrets: inherit

  build-mod-fabric:
    name: Build Fabric Mod
    needs: [prepare-release, build-server]
    if: ${{ needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run }}
    uses: ./.github/workflows/build-mod-fabric.yml
    with:
      version: ${{ needs.prepare-release.outputs.new_release_version }}
    secrets: inherit

  build-mod-paper:
    name: Build Paper Plugin
    needs: [prepare-release, build-server]
    if: ${{ needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run }}
    uses: ./.github/workflows/build-mod-paper.yml
    with:
      version: ${{ needs.prepare-release.outputs.new_release_version }}
    secrets: inherit

  build-mod-hytale:
    name: Build Hytale Plugin
    needs: [prepare-release, build-server]
    if: ${{ needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run }}
    uses: ./.github/workflows/build-mod-hytale.yml
    with:
      version: ${{ needs.prepare-release.outputs.new_release_version }}
    secrets: inherit

  publish-modrinth-fabric:
    name: Publish Fabric to Modrinth
    needs: [prepare-release, build-mod-fabric]
    if: ${{ needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-fabric-${{ needs.prepare-release.outputs.new_release_version }}
          path: ./artifacts

      - name: List artifacts
        run: ls -la ./artifacts

      - name: Publish to Modrinth
        uses: cloudnode-pro/modrinth-publish@v2
        with:
          token: ${{ secrets.MODRITH_PAT }}
          project: ${{ secrets.MODRITH_ID }}
          files: ./artifacts/bedrock-voice-chat-${{ needs.prepare-release.outputs.new_release_version }}.jar
          primary-file: bedrock-voice-chat-${{ needs.prepare-release.outputs.new_release_version }}.jar
          version: ${{ needs.prepare-release.outputs.new_release_version }}
          name: Bedrock Voice Chat ${{ needs.prepare-release.outputs.new_release_version }} (Fabric)
          changelog: ${{ needs.prepare-release.outputs.new_release_notes }}
          dependencies: |-
            [{
              "project_id": "P7dR8mSH",
              "dependency_type": "required"
            }]
          loaders: |-
            fabric
          game-versions: |-
            1.21.11
          channel: ${{ github.ref_name == 'beta' && 'beta' || 'release' }}

  publish-modrinth-paper:
    name: Publish Paper to Modrinth
    needs: [prepare-release, build-mod-paper]
    if: ${{ needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-paper-${{ needs.prepare-release.outputs.new_release_version }}
          path: ./artifacts

      - name: List artifacts
        run: ls -la ./artifacts

      - name: Publish to Modrinth
        uses: cloudnode-pro/modrinth-publish@v2
        with:
          token: ${{ secrets.MODRITH_PAT }}
          project: ${{ secrets.MODRITH_ID }}
          files: ./artifacts/bedrock-voice-chat-paper-${{ needs.prepare-release.outputs.new_release_version }}.jar
          primary-file: bedrock-voice-chat-paper-${{ needs.prepare-release.outputs.new_release_version }}.jar
          version: ${{ needs.prepare-release.outputs.new_release_version }}-paper
          name: Bedrock Voice Chat ${{ needs.prepare-release.outputs.new_release_version }} (Paper)
          changelog: ${{ needs.prepare-release.outputs.new_release_notes }}
          loaders: |-
            paper
            spigot
            bukkit
          game-versions: |-
            1.21.11
          channel: ${{ github.ref_name == 'beta' && 'beta' || 'release' }}

  # Upload all mod artifacts to GitHub Release
  upload-release-assets:
    name: Upload Release Assets
    needs: [prepare-release, build-mod-fabric, build-mod-paper, build-mod-hytale]
    if: always() && needs.prepare-release.outputs.new_release_published == 'true' && !inputs.dry-run && (needs.build-mod-fabric.result == 'success' || needs.build-mod-paper.result == 'success' || needs.build-mod-hytale.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Fabric artifact
        if: needs.build-mod-fabric.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-fabric-${{ needs.prepare-release.outputs.new_release_version }}
          path: ./release-files

      - name: Download Paper artifact
        if: needs.build-mod-paper.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-paper-${{ needs.prepare-release.outputs.new_release_version }}
          path: ./release-files

      - name: Download Hytale artifact
        if: needs.build-mod-hytale.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bedrock-voice-chat-hytale-${{ needs.prepare-release.outputs.new_release_version }}
          path: ./release-files

      - name: Rename artifacts
        run: |
          VERSION="${{ needs.prepare-release.outputs.new_release_version }}"
          cd ./release-files

          # Rename to consistent naming
          if [ -f "bedrock-voice-chat-${VERSION}.jar" ]; then
            mv "bedrock-voice-chat-${VERSION}.jar" "bvc-fabric-mod-${VERSION}.jar"
          fi

          if [ -f "bedrock-voice-chat-paper-${VERSION}.jar" ]; then
            mv "bedrock-voice-chat-paper-${VERSION}.jar" "bvc-paper-plugin-${VERSION}.jar"
          fi

          if [ -f "bedrock-voice-chat-hytale-${VERSION}.jar" ]; then
            mv "bedrock-voice-chat-hytale-${VERSION}.jar" "bvc-hytale-plugin-${VERSION}.jar"
          fi

          echo "=== Release files ==="
          ls -la

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: java-mod-v${{ needs.prepare-release.outputs.new_release_version }}
          files: ./release-files/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          VERSION="${{ needs.prepare-release.outputs.new_release_version }}"
          {
            echo "## Java Mod Release Assets Uploaded"
            echo ""
            echo "Version: **java-mod-v${VERSION}**"
            echo ""
            echo "### Uploaded Files"
            echo ""
            for file in ./release-files/*.jar; do
              if [ -f "$file" ]; then
                echo "- \`$(basename $file)\`"
              fi
            done
          } >> $GITHUB_STEP_SUMMARY