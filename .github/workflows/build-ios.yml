name: Build iOS Client
permissions:
  contents: read

on:
  push:
    branches: [ master ]
    paths:
      - 'client/**'
      - 'common/**'
      - '.github/workflows/build-ios.yml'
  pull_request:
    paths:
      - 'client/**'
      - 'common/**'
      - '.github/workflows/build-ios.yml'
  workflow_call:
    inputs:
      build_mode:
        description: 'Build mode (debug or release)'
        required: false
        default: 'debug'
        type: string
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build-ios:
    name: Build iOS (${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }})
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'yarn'
          cache-dependency-path: client/yarn.lock

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "."

      - name: Install JavaScript dependencies
        working-directory: ./client
        run: yarn install --frozen-lockfile

      - name: Set up cargo config
        working-directory: ./client
        run: |
          echo "Setting up .cargo/config.toml for iOS build..."
          cp ../.github/client/.cargo/config.toml ./src-tauri/.cargo/config.toml
          cat ./src-tauri/.cargo/config.toml

      - name: Initialize Tauri iOS project
        working-directory: ./client
        run: |
          echo "Initializing Tauri iOS project..."
          yarn tauri ios init
          echo "iOS project initialized successfully"

      - name: Copy custom iOS icons
        working-directory: ./client
        run: |
          echo "Copying custom iOS icons..."

          SOURCE_ICONS="src-tauri/icons/Assets.xcassets"
          TARGET_ASSETS="src-tauri/gen/apple/bedrock-voice-chat-client_iOS/Assets.xcassets"

          if [ ! -d "$SOURCE_ICONS" ]; then
            echo "Warning: Source icons path not found: $SOURCE_ICONS"
            exit 1
          fi

          if [ ! -d "src-tauri/gen/apple/bedrock-voice-chat-client_iOS" ]; then
            echo "Warning: Target iOS project path not found"
            ls -la src-tauri/gen/apple/ || true
            exit 1
          fi

          # Copy the entire Assets.xcassets directory
          cp -R "$SOURCE_ICONS" "$TARGET_ASSETS"

          echo "iOS icon copying completed."

          # Verify icons were copied
          echo "Verifying copied icons:"
          ls -la "$TARGET_ASSETS/AppIcon.appiconset/" | head -20

      - name: Copy Info.plist
        working-directory: ./client
        run: |
          echo "Copying custom Info.plist..."

          SOURCE_PLIST="../.github/Info.plist"
          TARGET_PLIST="src-tauri/gen/apple/bedrock-voice-chat-client_iOS/Info.plist"

          if [ ! -f "$SOURCE_PLIST" ]; then
            echo "Error: Source Info.plist not found at $SOURCE_PLIST"
            exit 1
          fi

          cp "$SOURCE_PLIST" "$TARGET_PLIST"

          echo "Info.plist copied successfully"
          echo "Contents:"
          cat "$TARGET_PLIST"

      - name: Build iOS (aarch64)
        working-directory: ./client
        run: |
          yarn tauri info

          # Force debug mode for PR builds, otherwise use input parameter
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR detected - building in debug mode"
            yarn tauri ios build --target aarch64
          elif [ "${{ inputs.build_mode || 'debug' }}" = "release" ]; then
            echo "Building in release mode"
            yarn tauri ios build --target aarch64 --release
          else
            echo "Building in debug mode"
            yarn tauri ios build --target aarch64
          fi

      - name: Build summary
        run: |
          BUILD_MODE="${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }}"
          echo "iOS Build Complete!"
          echo "Build Mode: $BUILD_MODE"
          echo "Trigger: ${{ github.event_name }}"
          echo "Target: aarch64-apple-ios"
