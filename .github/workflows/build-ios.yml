name: Build iOS Client
permissions:
  contents: read

on:
  workflow_call:
    inputs:
      build_mode:
        description: 'Build mode (debug or release)'
        required: false
        default: 'debug'
        type: string
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build-ios:
    name: Build iOS (${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }})
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'yarn'
          cache-dependency-path: client/yarn.lock

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "."

      - name: Install JavaScript dependencies
        working-directory: ./client
        run: yarn install --frozen-lockfile

      - name: Set up cargo config
        working-directory: ./client
        run: |
          echo "Setting up .cargo/config.toml for iOS build..."
          cp ../.github/client/.cargo/config.toml ./src-tauri/.cargo/config.toml
          cat ./src-tauri/.cargo/config.toml

      - name: Initialize Tauri iOS project
        working-directory: ./client
        run: yarn tauri:ios:init

      - name: Disable code signing for CI
        working-directory: ./client
        run: |
          echo "Disabling code signing for CI build..."
          PBXPROJ="src-tauri/gen/apple/bedrock-voice-chat-client.xcodeproj/project.pbxproj"

          # Disable code signing in the Xcode project
          sed -i '' 's/CODE_SIGN_IDENTITY = "[^"]*"/CODE_SIGN_IDENTITY = "-"/g' "$PBXPROJ"
          sed -i '' 's/DEVELOPMENT_TEAM = "[^"]*"/DEVELOPMENT_TEAM = ""/g' "$PBXPROJ"

          # Ensure CODE_SIGNING_REQUIRED and CODE_SIGNING_ALLOWED are set to NO
          if ! grep -q "CODE_SIGNING_REQUIRED" "$PBXPROJ"; then
            sed -i '' 's/CLANG_ENABLE_MODULES = YES;/CLANG_ENABLE_MODULES = YES;\n\t\t\t\tCODE_SIGNING_REQUIRED = NO;\n\t\t\t\tCODE_SIGNING_ALLOWED = NO;/g' "$PBXPROJ"
          fi

          echo "Code signing disabled"

      - name: Build frontend
        working-directory: ./client
        run: yarn build

      - name: Build Rust for iOS (aarch64)
        working-directory: ./client/src-tauri
        run: |
          # Determine build mode
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR detected - building in debug mode"
            cargo build --target aarch64-apple-ios
          elif [ "${{ inputs.build_mode || 'debug' }}" = "release" ]; then
            echo "Building in release mode"
            cargo build --target aarch64-apple-ios --release
          else
            echo "Building in debug mode"
            cargo build --target aarch64-apple-ios
          fi

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }}
          path: client/src-tauri/target/aarch64-apple-ios/${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }}/
          retention-days: 7

      - name: Build summary
        run: |
          BUILD_MODE="${{ github.event_name == 'pull_request' && 'debug' || inputs.build_mode || 'debug' }}"
          {
            echo "## iOS Build Complete"
            echo ""
            echo "| Name | Value |"
            echo "| ---- | ----- |"
            echo "| Build Mode | $BUILD_MODE |"
            echo "| Trigger | ${{ github.event_name }} |"
            echo "| Target | aarch64-apple-ios |"
          } >> $GITHUB_STEP_SUMMARY
